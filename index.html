<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>æ³¨æ–‡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
<style>
  :root{
    --blue:#0055a4; --blue-dark:#003d7a; --bg:#f5f7fa; --card:#fff; --text:#1a1a1a;
    --border:#dce1e8; --red:#c62828; --green:#2e7d32;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding-bottom:92px}

  .hero{background:linear-gradient(160deg,var(--blue) 0%,var(--blue-dark) 100%);color:#fff;padding:22px 16px;text-align:center}
  .hero h1{font-size:1.35rem;margin:0;font-weight:800;letter-spacing:.02em}

  .progress-bar{display:flex;gap:4px;padding:14px 16px;max-width:520px;margin:0 auto}
  .progress-step{flex:1;height:4px;background:var(--border);border-radius:2px}
  .progress-step.active{background:var(--blue)}
  .progress-step.done{background:var(--green)}

  .container{max-width:520px;margin:0 auto;padding:0 16px}
  .step{display:none;animation:fadeIn .25s ease}
  .step.active{display:block}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  .card{background:var(--card);border-radius:14px;padding:18px;margin-bottom:14px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .card-title{font-weight:800;color:var(--blue);margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:10px}

  .field{margin-bottom:16px}
  .field label{display:block;font-weight:700;font-size:.92rem;margin-bottom:6px}

  .field input:not([type="checkbox"]):not([type="radio"]):not([type="date"]),
  .field select,
  .field textarea{
    width:100%; padding:12px; border:2px solid var(--border); border-radius:10px; font-size:1rem;
    -webkit-appearance:none; background:#fff; outline:none;
  }
  .field input[type="date"]{
    width:100%; padding:12px; border:2px solid var(--border); border-radius:10px; font-size:1rem;
    background:#fff; outline:none;
  }
  .field textarea{resize:vertical}
  .field-hint{font-size:.78rem;color:#5f6368;margin-top:6px}
  .error-msg{color:var(--red);font-size:.82rem;display:none;margin-top:6px;font-weight:800}
  .field.error input:not([type="checkbox"]):not([type="radio"]),
  .field.error select,
  .field.error textarea{border-color:var(--red);background:#fff8f8}
  .field.error .error-msg{display:block}

  .case-id-group{display:flex;gap:8px}
  .case-id-group select{width:36%}
  .case-id-group input{width:64%}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}

  .choice{
    border:2px solid var(--border); border-radius:10px; padding:12px 8px; text-align:center;
    font-size:.92rem; font-weight:800; cursor:pointer; background:#fff; transition:.15s;
    display:flex; align-items:center; justify-content:center; min-height:52px; user-select:none;
  }
  .choice input{display:none}
  .choice.selected{border-color:var(--blue); background:#e8f2fc; color:var(--blue)}

  /* æ©Ÿå™¨å°æ•° */
  .equip-row{
    display:flex;justify-content:space-between;align-items:center;background:#fff;border:2px solid var(--border);
    border-radius:10px;padding:12px;margin-bottom:8px;gap:10px
  }
  .equip-row.active{border-color:var(--blue); background:#f0f8ff}
  .equip-label{font-size:.95rem;font-weight:800;flex:1}

  /* ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
  #repair_options_area{margin-top:12px;display:none}
  .repair-item-row{
    display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--border);
    border-radius:10px;padding:10px;margin-bottom:8px;gap:10px
  }
  .repair-item-row.active{border-color:var(--blue); background:#f0f8ff}
  .repair-info{font-size:.9rem;font-weight:800;flex:1}
  .repair-info small{font-weight:700;color:#666}
  .counter-ui{display:flex;align-items:center;gap:8px}
  .btn-circle{
    width:34px;height:34px;border-radius:50%;border:1px solid #ccc;background:#fff;cursor:pointer;
    font-size:1.2rem;display:flex;align-items:center;justify-content:center
  }
  .count-num{font-weight:900;width:22px;text-align:center}

  .extra-box{
    margin-top:10px;padding:12px;background:#fffdf3;border:1px solid #ffe0a3;border-radius:10px
  }
  .extra-row{
    display:flex;align-items:center;gap:10px;padding:10px;border:1px dashed #ffd48a;border-radius:10px;
    background:#fff; margin-top:8px
  }
  .extra-row input[type="checkbox"]{
    width:22px;height:22px; -webkit-appearance:auto; appearance:auto; transform:none;
  }
  .extra-row .txt{font-weight:800}
  .extra-row .sub{font-size:.8rem;color:#666;margin-left:auto}

  .discount-box{margin-top:12px;padding:12px;background:#fff3e0;border:1px solid #ffcc80;border-radius:10px}
  .btn-apply{background:#e65100;color:#fff;border:none;padding:7px 12px;border-radius:8px;font-weight:900;cursor:pointer}
  .coupon-success{color:var(--green)}
  .coupon-error{color:var(--red)}

  .confirm-row{display:flex;border-bottom:1px solid #eee;padding:9px 0;font-size:.92rem;gap:10px}
  .confirm-label{width:110px;color:#666;font-weight:700;flex-shrink:0}
  .confirm-val{flex:1;font-weight:800}

  .agreement-section{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:14px;margin-top:14px}
  .consent-copy-box{
    background:#e3f2fd;padding:10px;border-radius:10px;border:1px solid #90caf9;
    font-weight:900;color:#0d47a1;text-align:center;margin:10px 0;user-select:all
  }

  /* ç´„æ¬¾è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  .terms-box{
    background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:16px;
    font-size:.92rem; line-height:1.7; height:400px; overflow-y:scroll; margin-bottom:16px;
  }
  .terms-box ul{padding-left:1.4em;margin:0}
  .terms-box li{margin-bottom:.8em}

  .big-check{
    display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:2px dashed #ddd;background:#fff
  }
  .big-check input[type="checkbox"]{
    width:22px;height:22px; -webkit-appearance:auto; appearance:auto; transform:none;
  }
  .big-check .t{font-weight:900;color:var(--red)}
  .big-check .s{font-size:.82rem;color:#666;font-weight:700}

  /* è¦‹ç©æ›¸ãƒ†ãƒ¼ãƒ–ãƒ« */
  .estimate-table{width:100%;border-collapse:collapse;margin:12px 0;font-size:.9rem}
  .estimate-table th,.estimate-table td{border:1px solid #ccc;padding:8px 10px;text-align:left}
  .estimate-table th{background:#f0f4f8;font-weight:800;color:var(--blue)}
  .estimate-table .total-row{background:#e3f2fd;font-weight:900;font-size:1rem}

  .bottom-nav{
    position:fixed;bottom:0;left:0;right:0;background:#fff;padding:14px;display:flex;gap:10px;
    box-shadow:0 -2px 12px rgba(0,0,0,.08);z-index:100
  }
  .btn{flex:1;padding:12px;border-radius:10px;font-weight:900;border:none;cursor:pointer;text-align:center;font-size:1rem}
  .btn-next{background:var(--blue);color:#fff}
  .btn-back{background:#eee;color:#555}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .complete-screen{text-align:center;padding:36px 16px}
  .complete-icon{font-size:3rem;margin-bottom:8px}

  /* ç´„æ¬¾åŒæ„ãƒœã‚¿ãƒ³ç„¡åŠ¹æ™‚ */
  .terms-agree-disabled{opacity:.4;pointer-events:none}
</style>
</head>

<body>
  <form class="h-adr">
  <span class="p-country-name" style="display:none;">Japan</span>

  <div class="hero">
    <h1>æ³¨æ–‡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h1>
    <div id="additionalBadge" style="display:none; margin-top:6px; background:rgba(255,255,255,0.2); border-radius:8px; padding:4px 12px; font-size:.85rem; font-weight:700;">
      ğŸ”§ è¿½åŠ å·¥äº‹ãƒ¢ãƒ¼ãƒ‰ï½œ<span id="badgeCaseId"></span> <span id="badgeCustomerName"></span>
    </div>
  </div>

  <!-- Step: 1=é¡§å®¢æƒ…å ± 2=ç´„æ¬¾ 3=æ©Ÿå™¨ãƒ»ç—‡çŠ¶ 4=ä½œæ¥­å†…å®¹ 5=æ—¥ä»˜ãƒ»ç¢ºèª 6=ãŠè¦‹ç©ã‚Š 7=å¥‘ç´„æ‰¿è«¾ 8=å®Œäº† -->
  <div class="progress-bar">
    <div class="progress-step active" id="p1"></div>
    <div class="progress-step" id="p2"></div>
    <div class="progress-step" id="p3"></div>
    <div class="progress-step" id="p4"></div>
    <div class="progress-step" id="p5"></div>
    <div class="progress-step" id="p6"></div>
    <div class="progress-step" id="p7"></div>
  </div>

  <div class="container">

    <!-- ===== Step1: æ¡ˆä»¶ç®¡ç†ï¼‹ãŠå®¢æ§˜æƒ…å ± ===== -->
    <div class="step active" id="step1">
      <div class="card">
        <div class="card-title">ğŸ“ æ¡ˆä»¶ç®¡ç†ï¼ˆå¿…é ˆï¼‰</div>
        <div class="field" id="f_case">
          <label>æ¡ˆä»¶ç•ªå· <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <div class="case-id-group">
            <select id="c_case_prefix">
              <option value="YA">YA</option>
              <option value="HM">HM</option>
              <option value="CP">CP</option>
            </select>
            <input type="number" id="c_case_num" placeholder="ç•ªå·ï¼ˆä¾‹ï¼š1234ï¼‰" inputmode="numeric" />
          </div>
          <div class="error-msg">æ¡ˆä»¶ç•ªå·ï¼ˆç•ªå·ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>

        <div class="field" id="f_emp">
          <label>æ‹…å½“ID <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="text" id="c_emp_id" placeholder="ä¾‹ï¼š1001" />
          <div class="error-msg">æ‹…å½“IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>

        <div class="card-title" style="margin-top:16px;">ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±ï¼ˆå¿…é ˆï¼‰</div>
        <div class="field" id="f_name">
          <label>ãŠåå‰ <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="text" id="c_name" />
          <div class="error-msg">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field">
          <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="c_kana" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦" />
        </div>
        <div class="field" id="f_tel">
          <label>é›»è©±ç•ªå· <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="tel" id="c_tel" placeholder="ä¾‹ï¼š09012345678" inputmode="tel" />
          <div class="error-msg">é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field" id="f_email">
          <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="email" id="c_email" placeholder="ä¾‹ï¼šxxx@example.com" inputmode="email" />
          <div class="error-msg">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field" id="f_zip">
          <label>éƒµä¾¿ç•ªå· <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="tel" id="c_zip" class="p-postal-code" maxlength="8" placeholder="ä¾‹ï¼š1760001" inputmode="numeric" />
          <div class="field-hint">â€»ãƒã‚¤ãƒ•ãƒ³ç„¡ã—ã§å…¥åŠ›ã™ã‚‹ã¨ä½æ‰€ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
          <div class="error-msg">éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field" id="f_addr">
          <label>ã”ä½æ‰€ <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="text" id="c_address" class="p-region p-locality p-street-address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½ç·´é¦¬åŒº..." />
          <div class="error-msg">ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field">
          <label>å»ºç‰©åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="c_building" placeholder="ä¾‹ï¼šâ—¯â—¯ãƒãƒ³ã‚·ãƒ§ãƒ³101" />
        </div>
      </div>
    </div>

    <!-- ===== Step2: ç´„æ¬¾ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¿…é ˆï¼‰ ===== -->
    <div class="step" id="step2">
      <div class="card">
        <div class="card-title">ğŸ“„ ä½œæ¥­ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ç´„æ¬¾ï¼ˆå…¨æ–‡ï¼‰</div>
        <p style="font-size:.9rem; color:#666; margin-bottom:10px;">
          ä»¥ä¸‹ã®å†…å®¹ã‚’<strong>æœ€å¾Œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</strong>ã—ã¦ã”ç¢ºèªãã ã•ã„ã€‚
        </p>

        <div class="terms-box" id="termsBox" style="white-space:pre-wrap; font-size:.9rem; line-height:1.55;">
ã€ä½œæ¥­ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ç´„æ¬¾ã€‘ æ–½å·¥ä¼šç¤¾ãŒæä¾›ã™ã‚‹ä½œæ¥­ãƒ»
ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã«ã‚ãŸã‚Šã€æ³¨æ–‡å‰ã«ä½œæ¥­ãƒ»
ã‚µãƒ¼ãƒ“ã‚¹ç´„æ¬¾ã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚
ãƒ»ç¾é‡‘ ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
â€»ä¸Šè¨˜å¤–ã®ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ã”å¸Œæœ›ã®éš›ã¯
ä½œæ¥­å‰ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
â€»ãŠå®¢æ§˜è¨˜å…¥æ¬„ï¼ˆå¿…ãšç›´ç­†ã«ã¦ã”ç½²åãã ã•ã„ï¼‰ä¸€æ–¹ã®ã‚µã‚¤ãƒ³ã‚’çœç•¥ã—ãŸå ´åˆã‚‚å„äº‹é …ã®å†…å®¹å…¨ã¦ã«åŒæ„ã—ãŸã¨ã¿ãªã—ã¾ã™ã€‚
â—ä½œæ¥­ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®èª¬æ˜ã‚’å—ã‘ã‚µãƒ¼ãƒ“ã‚¹ç´„æ¬¾ãƒ»è¦‹ç©æ›¸ã«åŒæ„ã—ç™ºæ³¨ã™ã‚‹ã€‚
â—å½“ç¤¾ã®è»½éå¤±ã«ã‚ˆã‚‹å ´åˆã«ã¯ã€å½“ç¤¾ãŒè² ã†æå®³è³ å„Ÿã®é¡ã¯ã€ä½œæ¥­ãƒ»
ã‚µãƒ¼ãƒ“ã‚¹æ–™é‡‘ã®é‡‘é¡ã‚’è¶…ãˆãªã„ç¯„å›²ã¨ã™ã‚‹ã€‚
â—äºˆç´„æ™‚ã®æ–™é‡‘æ¡ˆå†…ã¨ç›¸é•ãŒç™ºç”Ÿã—ãŸéš›ã¯ã€ç¾å ´ã§æ¡ˆå†…ã—ãŸæ–™é‡‘ã«
åŒæ„ã—ç™ºæ³¨ã™ã‚‹ã€‚
â—è£é¢ã®ï½¢å€‹äººæƒ…å ±ã®å–æ‰±ã„ã«ã¤ã„ã¦ã€ ã‚’ç¢ºèªã—åŒæ„ã™ã‚‹ã€‚
â—ä½œæ¥­ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã—ãŸã€‚
â—ä½œæ¥­å¾Œå›åã—ãŸè£½å“ã‚„éƒ¨å“ã¯æ–½å·¥ä¼šç¤¾ãŒç ´æ£„ã™ã‚‹ã“ã¨ã‚’äº†æ‰¿ã™ã‚‹ã€‚
ãŠå®¢æ§˜ç½²åæ¬„ å°
ãŠå®¢æ§˜ç½²åæ¬„ å°
1. æ–½å·¥ä¼šç¤¾ã¯ã€æ³¨æ–‡è€…ã«å¯¾ã—ã€æœ¬å¥‘ç´„æ›¸ã«å®šã‚ã‚‰ã‚Œ
ãŸå·¥äº‹ã‚’è¡Œã„ã¾ã™ã€‚
2. æœ¬å¥‘ç´„æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæ–™é‡‘ã¯ã€ä½œæ¥­æ—¥ã¾ãŸã¯ä½œæ¥­
å®Œäº†æ—¥ã«æœ¬å¥‘ç´„æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæ–¹æ³•ã§ãŠæ”¯æ‰•ã„
ãã ã•ã„ã€‚
3. å·¥äº‹ã«é–¢ã™ã‚‹æ–™é‡‘ã¯ã€éƒ¨å“ä¸è‰¯ãŒèªã‚ã‚‰ã‚Œã‚‹å ´åˆã€
é©æ³•ã«å¥‘ç´„ã®è§£é™¤ã¾ãŸã¯å–æ¶ˆã—ãŒèªã‚ã‚‰ã‚Œã‚‹å ´åˆ
ã‚’é™¤ã„ã¦ã¯ã€è¿”é‡‘ã‚’è¡Œã‚ãªã„ã‚‚ã®ã¨ã—ã¾ã™ã€‚ãªãŠã€
ã“ã®è¦å®šã¯ã€æ³¨æ–‡è€…ã«ã‚ˆã‚‹æå®³è³ å„Ÿè«‹æ±‚ã‚„ä¸å½“åˆ©
å¾—è¿”é‚„è«‹æ±‚ã‚’å¦¨ã’ã‚‹ã‚‚ã®ã§ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚
4. å·¥äº‹ã«é–¢ã™ã‚‹æ–™é‡‘ã®æ”¯æ‰•æ–¹æ³•ã¯ã€åŸå‰‡ã€ç¾é‡‘ã€ã‚«ãƒ¼
ãƒ‰ã®ã¿ã¨ã—ã¾ã™(â€»é›†é‡‘ã®ã¿ã®ãŸã‚ã«ãŠä¼ºã„ã™ã‚‹
å ´åˆã€ç§»å‹•è²»ãƒ»æ‰‹æ•°æ–™ã‚’ã„ãŸã ãå ´åˆãŒã‚ã‚Šã¾
ã™)ã€‚æŒ¯è¾¼ã«ã‚ˆã‚‹ãŠæ”¯æ‰•ã„ã®éš›ã€å¿…è¦ã¨ãªã‚‹è«‹æ±‚æ›¸
ç™ºè¡Œã‚„æŒ¯è¾¼æ‰‹æ•°æ–™ãªã©ã®äº‹å‹™æ‰‹æ•°æ–™ã¯ã€æ³¨æ–‡è€…ãŒ
ã“ã‚Œã‚’è² æ‹…ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
5. ä½œæ¥­ã‚¹ã‚¿ãƒƒãƒ•ãŒæ‹ ç‚¹å‡ºç™ºå¾Œã«æ³¨æ–‡è€…éƒ½åˆã§ã‚­ãƒ£
ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹å ´åˆã€ç‰¹æ®Šãªç’°å¢ƒã‚„çŠ¶æ³ã®éš›(é åœ°ã€
é›¢å³¶ãªã©)ã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã”ã–
ã„ã¾ã™ã€‚éƒ¨å“ç™ºæ³¨å¾Œã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ã•ã‚Œã‚‹å ´åˆã€
ä»–ã®å·¥äº‹ã«è»¢ç”¨ã—ãªã„éƒ¨å“ã«é–¢ã—ã¦ã¯ã€ãã®ç™ºæ³¨
é‡‘é¡ã‚’ã”è² æ‹…ã„ãŸã ãã¾ã™ã€‚ãŸã ã—ã€ã‚¯ãƒ¼ãƒªãƒ³ã‚°
ã‚ªãƒ•ã®å ´åˆã‚’é™¤ãã¾ã™ã€‚
6. å·¥äº‹ã«é–¢ã™ã‚‹æ–™é‡‘ã®æ”¯æ‰•æœŸé™ã‹ã‚‰30æ—¥ä»¥ä¸Šé…å»¶ã—
ãŸå ´åˆã«ã¯ã€å‚µæ¨©å›åæ¥­è€…ã«å›åã‚’å§”ä»»ã™ã‚‹å ´åˆ
ãŒã‚ã‚Šã¾ã™ã€‚é…å»¶ã—ãŸå ´åˆã«ã¯ã€åˆ©æ¯åˆ¶é™æ³•ã«å¾“ã„
é…å»¶æå®³é‡‘ã‚’æ–½å·¥ä¼šç¤¾ã«æ”¯æ‰•ã†ã‚‚ã®ã¨ã—ã¾ã™ã€‚
7. æ³¨æ–‡è€…ã¯ã€å·¥äº‹ã®å¯¾è±¡ç‰©ã¯æ³¨æ–‡è€…æœ¬äººãŒæ‰€æœ‰ã—ã¦
ã„ã‚‹ã‚‚ã—ãã¯ç®¡ç†ã™ã‚‹æ¨©é™ã‚’ä¿æœ‰ã—ã¦ã„ã‚‹ã“ã¨
ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã¨ã—ã€ãã®ãŸã‚ã«å¿…è¦ãªèº«åˆ†è¨¼æ˜
æ›¸ã‚’æç¤ºã¾ãŸã¯å†™ã—ã‚’æå‡ºã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
8. æ³¨æ–‡è€…ã¯ã€å‰å·ã®æ ¹æ‹ ã¨ãªã‚‹ã€èº«åˆ†è¨¼æ˜æ›¸ã¯æœ¬äºº
ã®ã‚‚ã®ã§ã‚ã‚Šã€è¨˜è¼‰äº‹é …ã«èª¤ã‚ŠãŒãªã„ã“ã¨ã‚’ä¿è¨¼
ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
9. æ–½å·¥ä¼šç¤¾ã®è»½éå¤±ã«ã‚ˆã‚‹å ´åˆã«ã¯ã€æ–½å·¥ä¼šç¤¾ãŒè² 
ã†æå®³è³ å„Ÿã®é¡ã¯ã€å·¥äº‹ã«é–¢ã™ã‚‹æ–™é‡‘ã‚’ä¸Šé™ã¨ã—
ã¾ã™ã€‚
10. å¤©ç½äº‹å¤‰ã€æˆ¦äº‰ã€æš´å‹•ã€å†…ä¹±ã€åŒç›Ÿç½·æ¥­ã€äº‰è­°è¡Œå‹•ã
ã®ä»–ä¸å¯æŠ—åŠ›ã«ã‚ˆã‚Šå·¥äº‹ã®å…¨éƒ¨åˆã¯ä¸€éƒ¨ã®å±¥è¡Œ
ã®é…å»¶åˆã¯ä¸èƒ½ãŒç”Ÿã˜ãŸå ´åˆã€æ–½å·¥ä¼šç¤¾ã«å¯¾ã—ã¦
ãã®è²¬ä»»ã‚’å•ã†ã“ã¨ãŒå‡ºæ¥ãªã„ã‚‚ã®ã¨ã—ã¾ã™ã€‚
11. æ³¨æ–‡è€…ã¯ã€ä½œæ¥­å†…å®¹ãƒ»è¦‹ç©æ–™é‡‘ã«ã¤ã„ã¦æ–½å·¥ä¼šç¤¾
ã‚ˆã‚Šååˆ†ãªèª¬æ˜ã‚’å—ã‘ã€åŒæ„ã—å·¥äº‹ã‚’ä¾é ¼ã—ãŸã‚‚
ã®ã¨ã—ã¾ã™ã€‚
12. æ–½å·¥ä¼šç¤¾ãŒç¾å ´ã§å†™çœŸã‚’æ’®å½±ã•ã›ã¦é ‚ã„ãŸå ´åˆã«ãŠ
ã„ã¦ã€æ³¨æ–‡è€…ãŒã€æ–½å·¥ä¼šç¤¾ãŒå½“è©²å†™çœŸã‚’Webã‚µã‚¤ãƒˆãª
ã©ã®åª’ä½“ã«æ²è¼‰ã™ã‚‹ã“ã¨ã«æ‰¿è«¾ã•ã‚Œã‚‹å ´åˆã«ã¯ã€æ–½
å·¥ä¼šç¤¾ãŒå½“è©²å†™çœŸã®æ²è¼‰ã‚’è¡Œã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
13. æ³¨æ–‡è€…ã¯ã€æš´åŠ›å›£ã€æš´åŠ›å›£å“¡ã€æš´åŠ›å›£æº–æ§‹æˆå“¡ã€æš´
åŠ›å›£é–¢ä¿‚è€…ã€ç·ä¼šå±‹ãã®ä»–åç¤¾ä¼šçš„å‹¢åŠ›(ä»¥ä¸‹ã¾ã¨
ã‚ã¦ã€Œåç¤¾ä¼šçš„å‹¢åŠ›ã€ã¨ã„ã„ã¾ã™ã€‚)ã®ã„ãšã‚Œã§ã‚‚
ãªãã€åç¤¾ä¼šçš„å‹¢åŠ›ã¨ç¤¾ä¼šçš„ã«éé›£ã•ã‚Œã‚‹é–¢ä¿‚ã‚’
æœ‰ã•ãªã„ã“ã¨ã‚’ç¢ºç´„ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
14. æœ¬åˆ©ç”¨å¥‘ç´„ã«é–¢ã™ã‚‹è¨´ãˆã«ã¤ã„ã¦ã¯ã€æ±äº¬åœ°æ–¹è£
åˆ¤æ‰€ã‚’ç¬¬ä¸€å¯©ã®å°‚å±çš„åˆæ„ç®¡è½„è£åˆ¤æ‰€ã¨ã—ã¾ã™ã€‚
ä»–ã®è£åˆ¤æ‰€ã«ã¤ã„ã¦ç”Ÿã˜ã‚‹æ³•å®šç®¡è½„ã¯ã€æœ¬æ¡ã«ãŠ
ã‘ã‚‹åˆæ„ã‚’ã‚‚ã£ã¦ã“ã‚Œã‚’æ’é™¤ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
15. æ³¨æ–‡è€…ã¯ã€å·¥äº‹ã®å†…å®¹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«æ²è¼‰
ã—ãªã„ã“ã¨ã€åŠã³é•åã—ãŸå ´åˆã«æ–½å·¥ä¼šç¤¾ã«æå®³
ãŒç”Ÿã˜ãŸå ´åˆã«ã¯å½“è©²æå®³ã‚’è³ å„Ÿã™ã‚‹è²¬ä»»ã‚’è² 
ã†ã“ã¨ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã—ã¾ã™ã€‚
16. é ˜åæ›¸ã®å†ç™ºè¡Œã¯ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€éŠ€è¡ŒæŒ¯è¾¼ã®
å ´åˆã€æŒ¯è¾¼æ˜ç´°æ›¸ã‚’ã‚‚ã£ã¦é ˜åè¨¼ã®ç™ºè¡Œã«ä»£ãˆã•
ã›ã¦é ‚ãã¾ã™ã€‚
17. ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚„ã‚¯ãƒ¼ãƒãƒ³ç­‰ã®å‰²å¼•ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„
ã¦ã¯ã€ãŠé›»è©±ã§ã®ãŠå•ã„åˆã‚ã›ã€ã¾ãŸã¯ä½œæ¥­å‰ã«ãŠ
ç”³ã—å‡ºä¸‹ã•ã„ã€‚å·¥äº‹é–‹å§‹å¾Œã®ç”³å‘Šã«ã¤ã„ã¦ã¯ã€å‰²å¼•
ã‚µãƒ¼ãƒ“ã‚¹ã®å¯¾è±¡ã¨ã¯ãªã‚‰ãªã„ã‚‚ã®ã¨ã—ã¾ã™ã€‚
</div>

        <div id="termsScrollHint" style="text-align:center; color:var(--red); font-weight:800; font-size:.85rem; margin-bottom:10px; animation: pulse 1.5s infinite;">
          â–¼ æœ€å¾Œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ â–¼
        </div>
        <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}</style>

        <div class="field" id="termsAgreeWrap">
          <label class="big-check terms-agree-disabled" id="termsAgreeLabel" style="border-color:var(--blue); background:#e3f2fd;">
            <input type="checkbox" id="agree_terms_check" disabled />
            <div class="t" style="color:var(--blue)">ç´„æ¬¾ã®å†…å®¹ã‚’ç¢ºèªã—ã€åŒæ„ã—ã¾ã™</div>
          </label>
        </div>
      </div>
    </div>

    <!-- ===== Step3: å¯¾è±¡æ©Ÿå™¨ï¼ˆå°æ•°é¸æŠï¼‰ï¼‹ç—‡çŠ¶ ===== -->
    <div class="step" id="step3">
      <div class="card">
        <div class="card-title">ğŸ”§ å¯¾è±¡æ©Ÿå™¨ãƒ»å°æ•°</div>

        <div id="equipmentArea">
          <div class="equip-row" data-equip="ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³">
            <span class="equip-label">ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³</span>
            <div class="counter-ui">
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,-1)">-</button>
              <span class="count-num equip-count">0</span>
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,1)">+</button>
            </div>
          </div>
          <div class="equip-row" data-equip="æ¥­å‹™ç”¨ã‚¨ã‚¢ã‚³ãƒ³">
            <span class="equip-label">æ¥­å‹™ç”¨ã‚¨ã‚¢ã‚³ãƒ³</span>
            <div class="counter-ui">
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,-1)">-</button>
              <span class="count-num equip-count">0</span>
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,1)">+</button>
            </div>
          </div>
          <div class="equip-row" data-equip="ã‚¨ã‚³ã‚­ãƒ¥ãƒ¼ãƒˆ">
            <span class="equip-label">ã‚¨ã‚³ã‚­ãƒ¥ãƒ¼ãƒˆ</span>
            <div class="counter-ui">
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,-1)">-</button>
              <span class="count-num equip-count">0</span>
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,1)">+</button>
            </div>
          </div>
          <div class="equip-row" data-equip="ã‚¬ã‚¹çµ¦æ¹¯å™¨">
            <span class="equip-label">ã‚¬ã‚¹çµ¦æ¹¯å™¨</span>
            <div class="counter-ui">
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,-1)">-</button>
              <span class="count-num equip-count">0</span>
              <button class="btn-circle" type="button" onclick="changeEquipCount(this,1)">+</button>
            </div>
          </div>
        </div>
        <div class="error-msg" id="equipError" style="display:none;">å¯¾è±¡æ©Ÿå™¨ã‚’1å°ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„</div>

        <div class="card-title" style="margin-top:18px;">ğŸ©º ç—‡çŠ¶</div>
        <div class="field">
          <label>ç—‡çŠ¶ï¼ˆè¤‡æ•°é¸æŠOKï¼‰</label>
          <div class="grid-2" id="symptomGrid">
            <label class="choice"><input type="checkbox" name="symptom" value="å†·ãˆãªã„" />å†·ãˆãªã„</label>
            <label class="choice"><input type="checkbox" name="symptom" value="æ°´æ¼ã‚Œ" />æ°´æ¼ã‚Œ</label>
            <label class="choice"><input type="checkbox" name="symptom" value="é›»æºå…¥ã‚‰ãš" />é›»æºå…¥ã‚‰ãš</label>
            <label class="choice"><input type="checkbox" name="symptom" value="ç•°éŸ³ãƒ»è‡­ã„" />ç•°éŸ³ãƒ»è‡­ã„</label>
            <label class="choice"><input type="checkbox" name="symptom" value="ç‚¹æ»…" />ç‚¹æ»…</label>
            <label class="choice"><input type="checkbox" name="symptom" value="ãã®ä»–" />ãã®ä»–</label>
          </div>
        </div>

        <div class="field">
          <label>è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="c_detail" style="height:72px" placeholder="ä¾‹ï¼šå®¤å¤–æ©ŸãŒæ­¢ã¾ã‚‹ã€ç•°éŸ³ãŒã™ã‚‹ç­‰"></textarea>
        </div>
      </div>
    </div>

    <!-- ===== Step4: ä½œæ¥­å†…å®¹ï¼‹æ”¯æ‰•ã„ ===== -->
    <div class="step" id="step4">
      <div class="card">
        <div class="card-title">ğŸ“‹ ä½œæ¥­å†…å®¹</div>

        <div class="field">
          <label>ä½œæ¥­ç¨®åˆ¥</label>
          <div class="grid-2" id="orderTypeGrid">
            <label class="choice selected">
              <input type="radio" name="order_type" value="åŸå› ç©¶æ˜ä½œæ¥­" checked />
              æ•…éšœè¨ºæ–­è²»ç”¨(åŸå› ç©¶æ˜ä½œæ¥­)
            </label>
            <label class="choice">
              <input type="radio" name="order_type" value="ä¿®ç†" />
              ä¿®ç†
            </label>
          </div>

          <div id="repair_options_area">
            <div class="field-hint" style="margin-top:10px;color:#c62828;font-weight:900;">
              â€»ä¾¡æ ¼ã¯ç¨è¾¼ï¼ˆ2026å¹´æ”¹è¨‚ç‰ˆãƒ™ãƒ¼ã‚¹ï¼‰ï¼ã€Œåˆ¥é€”è¦‹ç©ã€ã¯é‡‘é¡ã«åŠ ç®—ã•ã‚Œã¾ã›ã‚“
            </div>

            <div class="repair-item-row" data-price="29700" data-name="å†·åª’ã‚¬ã‚¹æ³¨å…¥ï¼ˆ500gã¾ã§ï¼‰">
              <div class="repair-info">å†·åª’ã‚¬ã‚¹æ³¨å…¥ï¼ˆ500gã¾ã§ï¼‰<br><small>29,700å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="3300" data-name="å†·åª’ã‚¬ã‚¹è¿½åŠ ï¼ˆ100gã¾ã§ï¼‰">
              <div class="repair-info">å†·åª’ã‚¬ã‚¹è¿½åŠ ï¼ˆ100gã¾ã§ï¼‰<br><small>3,300å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="17600" data-name="çœŸç©ºå¼•ã">
              <div class="repair-info">çœŸç©ºå¼•ã<br><small>17,600å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="17600" data-name="ãƒ•ãƒ¬ã‚¢åŠ å·¥ãƒ»ãƒãƒ«ãƒ–ã‚³ã‚¢äº¤æ›">
              <div class="repair-info">ãƒ•ãƒ¬ã‚¢åŠ å·¥ãƒ»ãƒãƒ«ãƒ–ã‚³ã‚¢äº¤æ›<br><small>17,600å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="28600" data-name="æ°´æ¼ã‚Œä¿®å¾©å·¥è³ƒ">
              <div class="repair-info">æ°´æ¼ã‚Œä¿®å¾©å·¥è³ƒ<br><small>28,600å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="26400" data-name="å››æ–¹å¼å‹•ä½œä¸è‰¯è§£æ¶ˆå·¥è³ƒ">
              <div class="repair-info">å››æ–¹å¼å‹•ä½œä¸è‰¯è§£æ¶ˆå·¥è³ƒ<br><small>26,400å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="26400" data-name="é›»æºéƒ¨å†æ¥ç¶šä½œæ¥­">
              <div class="repair-info">é›»æºéƒ¨å†æ¥ç¶šä½œæ¥­<br><small>26,400å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="28600" data-name="ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šä»˜ã‘ï¼ˆæ¨™æº–å·¥äº‹ï¼‰">
              <div class="repair-info">ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šä»˜ã‘ï¼ˆæ¨™æº–å·¥äº‹ï¼‰<br><small>28,600å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="7700" data-name="å†·åª’ç®¡å»¶é•·ï¼ˆ1mæ¯ï¼‰">
              <div class="repair-info">å†·åª’ç®¡å»¶é•·ï¼ˆ1mæ¯ï¼‰<br><small>7,700å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="8800" data-name="ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šå¤–ã—å·¥è³ƒ">
              <div class="repair-info">ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šå¤–ã—å·¥è³ƒ<br><small>8,800å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="26400" data-name="ç©´é–‹ã‘å·¥è³ƒ">
              <div class="repair-info">ç©´é–‹ã‘å·¥è³ƒ<br><small>26,400å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>
            <div class="repair-item-row" data-price="26400" data-name="éƒ¨å“äº¤æ›/èª¿æ•´ï¼ˆç›®å®‰ï¼‰">
              <div class="repair-info">éƒ¨å“äº¤æ›/èª¿æ•´ï¼ˆç›®å®‰ï¼‰<br><small>26,400å††</small></div>
              <div class="counter-ui">
                <button class="btn-circle" type="button" onclick="changeCount(this,-1)">-</button>
                <span class="count-num">0</span>
                <button class="btn-circle" type="button" onclick="changeCount(this,1)">+</button>
              </div>
            </div>

            <div class="extra-box">
              <div style="font-weight:900;color:#8a4b00;">åˆ¥é€”è¦‹ç©ï¼ˆã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯é‡‘é¡ã«åŠ ç®—ã—ã¾ã›ã‚“ï¼‰</div>
              <label class="extra-row">
                <input type="checkbox" id="extra_relocate" />
                <span class="txt">ç§»è¨­è²»ç”¨</span>
                <span class="sub">åˆ¥é€”è²»ç”¨</span>
              </label>
              <label class="extra-row">
                <input type="checkbox" id="extra_hanging" />
                <span class="txt">å®¤å¤–æ©Ÿå¤©åŠã‚Š</span>
                <span class="sub">åˆ¥é€”è²»ç”¨</span>
              </label>
            </div>
          </div>
        </div>

        <div class="discount-box">
          <div style="display:flex; gap:10px;">
            <input type="text" id="c_coupon_code" placeholder="ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰" style="flex:1; padding:10px;" />
            <button type="button" class="btn-apply" onclick="applyCoupon()">é©ç”¨</button>
          </div>
          <div id="coupon_result" style="font-size:.85rem; margin-top:6px; font-weight:900;"></div>
        </div>

        <div class="field" style="margin-top:16px;">
          <label>ãŠæ”¯æ‰•ã„æ–¹æ³•</label>
          <div class="grid-3" id="paymentGrid">
            <label class="choice selected"><input type="radio" name="payment_method" value="ç¾é‡‘" checked />ç¾é‡‘</label>
            <label class="choice"><input type="radio" name="payment_method" value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰" />ã‚«ãƒ¼ãƒ‰</label>
            <label class="choice"><input type="radio" name="payment_method" value="ã”ç›¸è«‡" />ã”ç›¸è«‡</label>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Step5: å¥‘ç´„æ—¥ãƒ»ä½œæ¥­å®Œäº†æ—¥ ï¼‹ å…¥åŠ›å†…å®¹ç¢ºèª ===== -->
    <div class="step" id="step5">
      <div class="card">
        <div class="card-title">ğŸ“… å¥‘ç´„æ—¥ãƒ»ä½œæ¥­å®Œäº†æ—¥</div>
        <div class="field" id="f_contract_date">
          <label>å¥‘ç´„æ—¥ <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="date" id="c_contract_date" />
          <div class="error-msg">å¥‘ç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
        <div class="field" id="f_completion_date">
          <label>ä½œæ¥­å®Œäº†æ—¥ <span style="color:var(--red);font-weight:900;">â€»å¿…é ˆ</span></label>
          <input type="date" id="c_completion_date" />
          <div class="field-hint">â€»ä½œæ¥­å®Œäº†äºˆå®šæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          <div class="error-msg">ä½œæ¥­å®Œäº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">âœ… å…¥åŠ›å†…å®¹ã®ç¢ºèª</div>
        <div id="confirmContent"></div>
      </div>
    </div>

    <!-- ===== Step6: ãŠè¦‹ç©ã‚Š ===== -->
    <div class="step" id="step6">
      <div class="card">
        <div class="card-title">ğŸ’° ãŠè¦‹ç©ã‚Š</div>
        <div id="estimateContent"></div>
      </div>
    </div>

    <!-- ===== Step7: å¥‘ç´„æ‰¿è«¾ ===== -->
    <div class="step" id="step7">
      <div class="card">
        <div class="card-title">ğŸ§¾ ã”å¥‘ç´„æ‰¿è«¾ <span style="color:var(--red); font-size:.85em;">(é‡è¦)</span></div>

        <div class="field">
          <label>ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦å®š</label>
          <textarea id="cancel_rule" readonly style="height:70px; font-size:.9rem; background:#eee;">ãŠç”³è¾¼ã¿å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«è²»ç”¨ã¯100%ã‚’ç”³ã—å—ã‘ã¾ã™ã€‚</textarea>
        </div>

        <div class="field" style="margin-top:12px;">
          <label class="big-check">
            <input type="checkbox" id="req_sameday" />
            <div>
              <div class="t">ç·Šæ€¥äº‹æ…‹ã«ã¤ãå½“æ—¥å·¥äº‹ã‚’å¸Œæœ›ã™ã‚‹</div>
              <div class="s">â€»çŠ¶æ³ã«ã‚ˆã‚Šå¯¾å¿œã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™</div>
            </div>
          </label>
        </div>

        <div class="agreement-section">
          <label style="color:var(--blue); margin-bottom:10px;">
            ã€é›»å­äº¤ä»˜ã¸ã®æ‰¿è«¾ã€‘<span style="color:var(--red); font-size:.85rem;">â€»å¿…é ˆ</span>
          </label>

          <p style="font-size:.9rem; margin-bottom:10px;">
            ä¸‹ã®é’æ ã®æ–‡ç« ã‚’ã€å…¥åŠ›æ¬„ã«<strong>ä¸€å­—ä¸€å¥åŒã˜ã‚ˆã†ã«</strong>å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            ã“ã‚Œã«ã‚ˆã‚Šã€å¥‘ç´„æ›¸é¢ç­‰ã‚’é›»å­ãƒ¡ãƒ¼ãƒ«ï¼ˆPDFï¼‰ã§å—ã‘å–ã‚‹ã“ã¨ã«åŒæ„ã—ãŸè¨˜éŒ²ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
          </p>

          <div class="consent-copy-box">æ‰¿è«¾ã—ã¾ã™</div>

          <div class="field" id="f_consent" style="margin-bottom:10px;">
            <input type="text" id="consent_input" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„" style="border:2px solid var(--blue); background:#fff;" />
            <div class="error-msg" id="consent_error">ã€Œæ‰¿è«¾ã—ã¾ã™ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          </div>

          <div class="field" id="f_sign" style="margin-top:12px;">
            <label>ã”ç½²åï¼ˆãŠåå‰ï¼‰ <span style="color:var(--red); font-size:.85rem;">â€»å¿…é ˆ</span></label>
            <input type="text" id="c_signature" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" />
            <div class="error-msg">ã”ç½²åï¼ˆãŠåå‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            <div class="field-hint">å¥‘ç´„è€…ã”æœ¬äººã®ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Step8: å®Œäº† ===== -->
    <div class="step" id="step8">
      <div class="complete-screen">
        <div class="complete-icon">ğŸ‰</div>
        <h2 style="margin-bottom:8px;">å—ä»˜å®Œäº†ã—ã¾ã—ãŸ</h2>
        <p style="color:#555;font-weight:700;">
          ã”ç™»éŒ²ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€Œå¥‘ç´„æ›¸æ§ãˆï¼ˆPDFï¼‰ã€ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚<br>
          æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚
        </p>

        <div id="additionalWorkSection" style="margin-top:28px; padding:18px; background:#e3f2fd; border:2px solid #90caf9; border-radius:14px;">
          <p style="font-weight:800; color:#0d47a1; margin-bottom:6px; font-size:1rem;">è¿½åŠ å·¥äº‹ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ</p>
          <p style="font-size:.85rem; color:#555; margin-bottom:14px;">
            ãŠå®¢æ§˜æƒ…å ±ãƒ»æ©Ÿå™¨æƒ…å ±ã¯ãã®ã¾ã¾å¼•ãç¶™ãã¾ã™ã€‚<br>ä½œæ¥­å†…å®¹ã ã‘é¸ã³ç›´ã›ã¾ã™ã€‚
          </p>
          <button type="button" class="btn btn-next" style="width:100%; max-width:320px; font-size:1.05rem; padding:14px;"
            onclick="startAdditionalWork()">
            ğŸ”§ ã“ã®æ¡ˆä»¶ã§è¿½åŠ å·¥äº‹ã‚’ç™ºæ³¨ã™ã‚‹
          </button>
        </div>

        <div style="margin-top:16px;">
          <button type="button" class="btn btn-back" style="width:100%; max-width:320px; padding:12px;"
            onclick="resetAll()">
            æ–°ã—ã„æ¡ˆä»¶ã‚’å…¥åŠ›ã™ã‚‹
          </button>
        </div>
      </div>
    </div>

  </div>
  </form>

  <div class="bottom-nav">
    <button class="btn btn-back" onclick="prevStep()" id="btnBack" style="display:none" type="button">æˆ»ã‚‹</button>
    <button class="btn btn-next" onclick="nextStep()" id="btnNext" type="button">æ¬¡ã¸</button>
  </div>

<script>
/* =========================
  â˜…ã“ã“ã ã‘å·®ã—æ›¿ãˆå¿…é ˆâ˜…
========================= */
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw.../exec';

/* ========================= */
const TOTAL_STEPS = 7;       // é€²æ—ãƒãƒ¼ç”¨ï¼ˆå®Œäº†ç”»é¢é™¤ãï¼‰
const COMPLETE_STEP = 8;
let currentStep = 1;
let couponApplied = false;
let isAdditionalWork = false;
let submissionCount = 0;
let termsScrolled = false;

/* ========== åˆæœŸåŒ– ========== */
window.addEventListener('load', () => {
  const params = new URLSearchParams(location.search);
  const p_id = params.get('case_id');
  if (p_id) {
    const parts = p_id.split('-');
    if (parts.length > 1) {
      document.getElementById('c_case_prefix').value = parts[0];
      document.getElementById('c_case_num').value = parts[1];
    } else {
      document.getElementById('c_case_num').value = p_id;
    }
  }
  if (params.get('emp_id')) document.getElementById('c_emp_id').value = params.get('emp_id');
  if (params.get('name')) document.getElementById('c_name').value = params.get('name');
  if (params.get('tel')) document.getElementById('c_tel').value = params.get('tel');
  if (params.get('email')) document.getElementById('c_email').value = params.get('email');
  if (params.get('address')) document.getElementById('c_address').value = params.get('address');

  // å¥‘ç´„æ—¥ã‚’ä»Šæ—¥ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('c_contract_date').value = today;

  bindChoiceUI_('#symptomGrid', 'checkbox');
  bindChoiceUI_('#orderTypeGrid', 'radio', () => toggleRepairMenu());
  bindChoiceUI_('#paymentGrid', 'radio');
  toggleRepairMenu();

  // ç´„æ¬¾ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–
  const termsBox = document.getElementById('termsBox');
  termsBox.addEventListener('scroll', () => {
    const atBottom = (termsBox.scrollHeight - termsBox.scrollTop - termsBox.clientHeight) < 30;
    if (atBottom && !termsScrolled) {
      termsScrolled = true;
      const label = document.getElementById('termsAgreeLabel');
      label.classList.remove('terms-agree-disabled');
      document.getElementById('agree_terms_check').disabled = false;
      document.getElementById('termsScrollHint').style.display = 'none';
    }
  });

  updateUI();
});

/* ========== UI Binding ========== */
function bindChoiceUI_(containerSel, type, onChange) {
  const box = document.querySelector(containerSel);
  if (!box) return;
  const labels = Array.from(box.querySelectorAll('.choice'));
  const refresh = () => {
    labels.forEach(lb => {
      const inp = lb.querySelector('input');
      if (!inp) return;
      lb.classList.toggle('selected', inp.checked);
    });
  };
  labels.forEach(lb => {
    const inp = lb.querySelector('input');
    if (!inp) return;
    inp.addEventListener('change', () => {
      if (type === 'radio') refresh(); else lb.classList.toggle('selected', inp.checked);
      if (typeof onChange === 'function') onChange();
    });
    lb.addEventListener('click', (e) => {
      const i = lb.querySelector('input');
      if (!i) return;
      if (i.type === 'radio') i.checked = true;
      if (i.type === 'checkbox') i.checked = !i.checked;
      i.dispatchEvent(new Event('change', { bubbles: true }));
      e.preventDefault();
    });
  });
  refresh();
}

function toggleRepairMenu() {
  const isRepair = document.querySelector('input[name="order_type"][value="ä¿®ç†"]').checked;
  document.getElementById('repair_options_area').style.display = isRepair ? 'block' : 'none';
}

/* ========== æ©Ÿå™¨å°æ•° ========== */
function changeEquipCount(btn, delta) {
  const row = btn.closest('.equip-row');
  const sp = row.querySelector('.count-num');
  let n = parseInt(sp.textContent || '0', 10) + delta;
  if (n < 0) n = 0;
  sp.textContent = String(n);
  row.classList.toggle('active', n > 0);
}

function getEquipmentList() {
  const items = [];
  document.querySelectorAll('.equip-row').forEach(row => {
    const n = parseInt(row.querySelector('.count-num').textContent || '0', 10);
    if (n > 0) items.push({ name: row.dataset.equip, count: n });
  });
  return items;
}

function getEquipmentText() {
  const items = getEquipmentList();
  if (!items.length) return 'ï¼ˆæœªé¸æŠï¼‰';
  return items.map(i => `${i.name} Ã—${i.count}`).join('ã€');
}

function getPrimaryEquipment() {
  // æ–™é‡‘è¨ˆç®—ç”¨ï¼šæœ€åˆã«é¸æŠã•ã‚ŒãŸæ©Ÿå™¨ã‚’è¿”ã™
  const items = getEquipmentList();
  if (!items.length) return 'ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³';
  return items[0].name;
}

/* ========== ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ========== */
function changeCount(btn, delta) {
  const row = btn.closest('.repair-item-row');
  const sp = row.querySelector('.count-num');
  let n = parseInt(sp.textContent || '0', 10) + delta;
  if (n < 0) n = 0;
  sp.textContent = String(n);
  row.classList.toggle('active', n > 0);
}

function getSelectedSymptoms() {
  const arr = Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(c => c.value);
  return arr.length ? arr.join('ã€') : 'ãªã—';
}

function getSelectedRepair() {
  const items = [];
  document.querySelectorAll('.repair-item-row').forEach(row => {
    const n = parseInt(row.querySelector('.count-num').textContent || '0', 10);
    if (n > 0) items.push({ name: row.dataset.name, price: parseInt(row.dataset.price), count: n });
  });
  if (document.getElementById('extra_relocate').checked) items.push({ name: 'ç§»è¨­è²»ç”¨ï¼ˆåˆ¥é€”è¦‹ç©ï¼‰', price: 0, count: 1 });
  if (document.getElementById('extra_hanging').checked) items.push({ name: 'å®¤å¤–æ©Ÿå¤©åŠã‚Šï¼ˆåˆ¥é€”è¦‹ç©ï¼‰', price: 0, count: 1 });
  return items;
}

function getSelectedRepairText() {
  const items = getSelectedRepair();
  if (!items.length) return 'ï¼ˆé¸æŠãªã—ï¼‰';
  return items.map(i => `${i.name} x${i.count}`).join('ã€');
}

function calcTotal() {
  let total = 0;
  document.querySelectorAll('.repair-item-row').forEach(row => {
    const n = parseInt(row.querySelector('.count-num').textContent || '0', 10);
    if (n > 0) total += (parseInt(row.dataset.price || '0', 10) * n);
  });
  if (couponApplied) total = Math.max(0, total - 3000);
  return total;
}

function applyCoupon() {
  const code = document.getElementById('c_coupon_code').value.trim();
  const out = document.getElementById('coupon_result');
  if (code === 'ac2026') {
    couponApplied = true;
    out.textContent = 'ã‚¯ãƒ¼ãƒãƒ³é©ç”¨ï¼š-3,000å††';
    out.className = 'coupon-success';
  } else {
    couponApplied = false;
    out.textContent = 'ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™';
    out.className = 'coupon-error';
  }
}

/* ========== æ–™é‡‘è¨ˆç®— ========== */
function getFeeInfo_() {
  const oType = document.querySelector('input[name="order_type"]:checked').value;
  const equip = getPrimaryEquipment();
  let label = '';
  let amt = 0;
  if (oType === 'åŸå› ç©¶æ˜ä½œæ¥­') {
    label = 'æ•…éšœè¨ºæ–­è²»ç”¨ï¼ˆç¨è¾¼ï¼‰';
    amt = (equip === 'ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³') ? 9900 : 15000;
    // å°æ•°åˆ†
    const items = getEquipmentList();
    if (items.length > 0) {
      amt = 0;
      items.forEach(i => {
        const unitPrice = (i.name === 'ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³') ? 9900 : 15000;
        amt += unitPrice * i.count;
      });
    }
    if (couponApplied) amt = Math.max(0, amt - 3000);
  } else {
    label = 'ä¿®ç†ä½œæ¥­è²»ç”¨ï¼ˆç›®å®‰ãƒ»ç¨è¾¼ï¼‰';
    amt = calcTotal();
  }
  return { label, amt };
}

/* ========== ç¢ºèªç”»é¢ç”Ÿæˆ ========== */
function buildConfirmation() {
  const prefix = document.getElementById('c_case_prefix').value;
  const num = document.getElementById('c_case_num').value.trim();
  const caseId = `${prefix}-${num}`;
  const d = {
    caseId,
    emp: document.getElementById('c_emp_id').value.trim(),
    name: document.getElementById('c_name').value.trim(),
    tel: document.getElementById('c_tel').value.trim(),
    email: document.getElementById('c_email').value.trim(),
    zip: document.getElementById('c_zip').value.trim(),
    address: document.getElementById('c_address').value.trim(),
    building: document.getElementById('c_building').value.trim(),
    equip: getEquipmentText(),
    sym: getSelectedSymptoms(),
    oType: document.querySelector('input[name="order_type"]:checked').value,
    pay: document.querySelector('input[name="payment_method"]:checked').value,
    contractDate: document.getElementById('c_contract_date').value,
    completionDate: document.getElementById('c_completion_date').value
  };

  const oTypeLabel = (d.oType === 'åŸå› ç©¶æ˜ä½œæ¥­') ? 'æ•…éšœè¨ºæ–­è²»ç”¨(åŸå› ç©¶æ˜ä½œæ¥­)' : 'ä¿®ç†';
  const repairText = (d.oType === 'ä¿®ç†') ? `<br><span style="font-size:.85rem;color:#666;">â”” ${esc_(getSelectedRepairText())}</span>` : '';
  const disc = couponApplied ? `<br><span style="color:#e65100;font-weight:900;">â€»ã‚¯ãƒ¼ãƒãƒ³é©ç”¨</span>` : '';
  const feeInfo = getFeeInfo_();
  const additionalTag = isAdditionalWork ? `<div style="background:#e3f2fd; color:#0d47a1; font-weight:900; padding:8px 12px; border-radius:8px; margin-bottom:12px; text-align:center; font-size:.95rem;">ğŸ”§ è¿½åŠ å·¥äº‹ï¼ˆ${submissionCount + 1}ä»¶ç›®ï¼‰</div>` : '';

  return `
    ${additionalTag}
    <div class="confirm-row"><span class="confirm-label">æ¡ˆä»¶ç•ªå·</span><span class="confirm-val">${esc_(d.caseId)}</span></div>
    <div class="confirm-row"><span class="confirm-label">æ‹…å½“ID</span><span class="confirm-val">${esc_(d.emp)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ãŠåå‰</span><span class="confirm-val">${esc_(d.name)}</span></div>
    <div class="confirm-row"><span class="confirm-label">é›»è©±</span><span class="confirm-val">${esc_(d.tel)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ãƒ¡ãƒ¼ãƒ«</span><span class="confirm-val">${esc_(d.email)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ä½æ‰€</span><span class="confirm-val">${esc_(d.zip)}<br>${esc_(d.address)} ${esc_(d.building)}</span></div>
    <div class="confirm-row"><span class="confirm-label">å¯¾è±¡æ©Ÿå™¨</span><span class="confirm-val">${esc_(d.equip)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ç—‡çŠ¶</span><span class="confirm-val">${esc_(d.sym)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ä½œæ¥­</span><span class="confirm-val" style="color:var(--blue)">${esc_(oTypeLabel)}${repairText}${disc}</span></div>
    <div class="confirm-row"><span class="confirm-label">åˆè¨ˆé‡‘é¡</span><span class="confirm-val" style="font-weight:900;color:var(--blue)">${feeInfo.amt.toLocaleString()}å††ï¼ˆç¨è¾¼ï¼‰</span></div>
    <div class="confirm-row"><span class="confirm-label">æ”¯æ‰•ã„</span><span class="confirm-val">${esc_(d.pay)}</span></div>
    <div class="confirm-row"><span class="confirm-label">å¥‘ç´„æ—¥</span><span class="confirm-val">${esc_(d.contractDate)}</span></div>
    <div class="confirm-row"><span class="confirm-label">ä½œæ¥­å®Œäº†æ—¥</span><span class="confirm-val">${esc_(d.completionDate)}</span></div>
  `;
}

/* ========== è¦‹ç©æ›¸ç”Ÿæˆ ========== */
function buildEstimate() {
  const oType = document.querySelector('input[name="order_type"]:checked').value;
  const feeInfo = getFeeInfo_();
  const prefix = document.getElementById('c_case_prefix').value;
  const num = document.getElementById('c_case_num').value.trim();
  const caseId = `${prefix}-${num}`;
  const name = document.getElementById('c_name').value.trim();
  const contractDate = document.getElementById('c_contract_date').value;

  let tableRows = '';

  if (oType === 'åŸå› ç©¶æ˜ä½œæ¥­') {
    const items = getEquipmentList();
    if (items.length > 0) {
      items.forEach(i => {
        const unitPrice = (i.name === 'ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³') ? 9900 : 15000;
        tableRows += `<tr><td>æ•…éšœè¨ºæ–­è²»ç”¨ï¼ˆ${esc_(i.name)}ï¼‰</td><td style="text-align:center">${i.count}</td><td style="text-align:right">${unitPrice.toLocaleString()}å††</td><td style="text-align:right">${(unitPrice * i.count).toLocaleString()}å††</td></tr>`;
      });
    }
  } else {
    const repairItems = getSelectedRepair();
    repairItems.forEach(i => {
      if (i.price > 0) {
        tableRows += `<tr><td>${esc_(i.name)}</td><td style="text-align:center">${i.count}</td><td style="text-align:right">${i.price.toLocaleString()}å††</td><td style="text-align:right">${(i.price * i.count).toLocaleString()}å††</td></tr>`;
      } else {
        tableRows += `<tr><td>${esc_(i.name)}</td><td colspan="3" style="text-align:center;color:#8a4b00;">åˆ¥é€”è¦‹ç©</td></tr>`;
      }
    });
  }

  if (couponApplied) {
    tableRows += `<tr style="color:#e65100;"><td>ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•</td><td style="text-align:center">1</td><td style="text-align:right">-3,000å††</td><td style="text-align:right">-3,000å††</td></tr>`;
  }

  return `
    <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <div>
          <div style="font-weight:900; font-size:1.1rem; color:var(--blue);">ãŠè¦‹ç©æ›¸</div>
          <div style="font-size:.85rem; color:#666;">æ¡ˆä»¶ç•ªå·ï¼š${esc_(caseId)}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:.85rem; color:#666;">æ—¥ä»˜ï¼š${esc_(contractDate)}</div>
        </div>
      </div>

      <div style="margin-bottom:12px; font-weight:700;">${esc_(name)} æ§˜</div>

      <table class="estimate-table">
        <thead>
          <tr><th>ä½œæ¥­å†…å®¹</th><th style="width:50px;text-align:center">æ•°é‡</th><th style="width:80px;text-align:right">å˜ä¾¡</th><th style="width:90px;text-align:right">é‡‘é¡</th></tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
        <tfoot>
          <tr class="total-row"><td colspan="3" style="text-align:right; font-weight:900;">åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</td><td style="text-align:right; font-weight:900; font-size:1.1rem; color:var(--blue);">${feeInfo.amt.toLocaleString()}å††</td></tr>
        </tfoot>
      </table>
    </div>

    <div style="font-size:.85rem; color:#666;">
      â€»ä¸Šè¨˜é‡‘é¡ã¯ç¨è¾¼è¡¨ç¤ºã§ã™ã€‚<br>
      â€»ã€Œåˆ¥é€”è¦‹ç©ã€ã®é …ç›®ã¯åˆè¨ˆé‡‘é¡ã«å«ã¾ã‚Œã¦ãŠã‚Šã¾ã›ã‚“ã€‚
    </div>
  `;
}

/* ========== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
function updateUI() {
  document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
  const active = document.getElementById('step' + currentStep);
  if (active) active.classList.add('active');

  for (let i = 1; i <= TOTAL_STEPS; i++) {
    const p = document.getElementById('p' + i);
    if (!p) continue;
    p.className = 'progress-step';
    if (i < currentStep) p.classList.add('done');
    if (i === currentStep) p.classList.add('active');
  }

  const back = document.getElementById('btnBack');
  const next = document.getElementById('btnNext');

  if (isAdditionalWork) {
    back.style.display = currentStep <= 4 ? 'none' : 'block';
  } else {
    back.style.display = currentStep === 1 ? 'none' : 'block';
  }

  if (currentStep === 7) {
    next.textContent = 'ä¸Šè¨˜ã«åŒæ„ã—ã¦é€ä¿¡';
  } else if (currentStep === COMPLETE_STEP) {
    document.querySelector('.bottom-nav').style.display = 'none';
  } else {
    next.textContent = 'æ¬¡ã¸';
  }
}

function nextStep() {
  if (!validateStep(currentStep)) return;

  // Step4çµ‚ã‚ã‚Šã§ç¢ºèªç”»é¢ç”Ÿæˆã®æº–å‚™ï¼ˆStep5ã§è¡¨ç¤ºï¼‰
  if (currentStep === 4) {
    // ç¢ºèªç”»é¢ã¯Step5è¡¨ç¤ºæ™‚ã«ãƒ“ãƒ«ãƒ‰
  }

  // Step5ï¼ˆæ—¥ä»˜ï¼‹ç¢ºèªï¼‰ã®è¡¨ç¤ºæ™‚ã«ç¢ºèªå†…å®¹ã‚’ç”Ÿæˆ
  if (currentStep === 4) {
    // Step5ã«å…¥ã‚‹å‰ã«ç¢ºèªå†…å®¹ã‚’ç”Ÿæˆ
  }

  // Step5ã®çµ‚ã‚ã‚Šã§è¦‹ç©æ›¸ç”Ÿæˆ
  if (currentStep === 5) {
    document.getElementById('estimateContent').innerHTML = buildEstimate();
  }

  if (currentStep === 7) { doSubmit(); return; }

  currentStep++;

  // Step5ã«å…¥ã£ãŸæ™‚ã«ç¢ºèªå†…å®¹ã‚’ç”Ÿæˆ
  if (currentStep === 5) {
    document.getElementById('confirmContent').innerHTML = buildConfirmation();
  }

  updateUI();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function prevStep() {
  const minStep = isAdditionalWork ? 4 : 1;
  if (currentStep > minStep) {
    currentStep--;
    // Step5ã«æˆ»ã£ãŸæ™‚ã«ç¢ºèªå†…å®¹ã‚’å†ç”Ÿæˆ
    if (currentStep === 5) {
      document.getElementById('confirmContent').innerHTML = buildConfirmation();
    }
    updateUI();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

/* ========== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
function setFieldError(fieldId, isError) {
  const f = document.getElementById(fieldId);
  if (!f) return;
  f.classList.toggle('error', !!isError);
}

function validateStep(step) {
  if (step === 1) {
    const caseNum = document.getElementById('c_case_num').value.trim();
    const emp = document.getElementById('c_emp_id').value.trim();
    const name = document.getElementById('c_name').value.trim();
    const tel = document.getElementById('c_tel').value.trim();
    const email = document.getElementById('c_email').value.trim();
    const zip = document.getElementById('c_zip').value.trim();
    const addr = document.getElementById('c_address').value.trim();

    setFieldError('f_case', !caseNum);
    setFieldError('f_emp', !emp);
    setFieldError('f_name', !name);
    setFieldError('f_tel', !tel);
    setFieldError('f_email', !email);
    setFieldError('f_zip', !zip);
    setFieldError('f_addr', !addr);

    if (!caseNum || !emp || !name || !tel || !email || !zip || !addr) {
      alert('æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚èµ¤æ ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
  }

  if (step === 2) {
    if (!document.getElementById('agree_terms_check').checked) {
      alert('ç´„æ¬¾ã‚’æœ€å¾Œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã€åŒæ„ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚');
      return false;
    }
  }

  if (step === 3) {
    const items = getEquipmentList();
    const err = document.getElementById('equipError');
    if (items.length === 0) {
      err.style.display = 'block';
      alert('å¯¾è±¡æ©Ÿå™¨ã‚’1å°ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
    err.style.display = 'none';
  }

  if (step === 5) {
    const cd = document.getElementById('c_contract_date').value;
    const cpd = document.getElementById('c_completion_date').value;
    setFieldError('f_contract_date', !cd);
    setFieldError('f_completion_date', !cpd);
    if (!cd || !cpd) {
      alert('å¥‘ç´„æ—¥ã¨ä½œæ¥­å®Œäº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
  }

  if (step === 7) {
    const inputConsent = document.getElementById('consent_input').value.trim();
    const signature = document.getElementById('c_signature').value.trim();

    setFieldError('f_consent', inputConsent !== 'æ‰¿è«¾ã—ã¾ã™');
    setFieldError('f_sign', !signature);

    if (inputConsent !== 'æ‰¿è«¾ã—ã¾ã™') {
      document.getElementById('consent_error').style.display = 'block';
      alert('é’æ å†…ã®æ–‡å­—ã€Œæ‰¿è«¾ã—ã¾ã™ã€ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return false;
    } else {
      document.getElementById('consent_error').style.display = 'none';
    }

    if (!signature) {
      alert('ã”ç½²åï¼ˆãŠåå‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
  }

  return true;
}

/* ========== é€ä¿¡ ========== */
function esc_(s) {
  return String(s || '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

async function doSubmit() {
  const btn = document.getElementById('btnNext');
  btn.disabled = true;
  btn.textContent = 'é€ä¿¡ä¸­...';

  const prefix = document.getElementById('c_case_prefix').value;
  const num = document.getElementById('c_case_num').value.trim();
  const caseId = `${prefix}-${num}`;

  const rawType = document.querySelector('input[name="order_type"]:checked').value;
  let orderType = rawType;
  if (rawType === 'åŸå› ç©¶æ˜ä½œæ¥­') orderType = 'æ•…éšœè¨ºæ–­è²»ç”¨(åŸå› ç©¶æ˜ä½œæ¥­)';
  if (rawType === 'ä¿®ç†') orderType = `ä¿®ç†ï¼š${getSelectedRepairText()}`;
  if (couponApplied) orderType += ' ã€ã‚¯ãƒ¼ãƒãƒ³åˆ©ç”¨ã€‘';
  if (document.getElementById('req_sameday').checked) orderType += ' ã€å½“æ—¥å¸Œæœ›ã€‘';

  const feeInfo = getFeeInfo_();

  const payload = {
    contract_id: caseId,
    emp_id: document.getElementById('c_emp_id').value.trim(),
    name: document.getElementById('c_name').value.trim(),
    kana: document.getElementById('c_kana').value.trim(),
    tel: document.getElementById('c_tel').value.trim(),
    email: document.getElementById('c_email').value.trim(),
    zip: document.getElementById('c_zip').value.trim(),
    address: document.getElementById('c_address').value.trim(),
    building: document.getElementById('c_building').value.trim(),
    equipment: getEquipmentText(),
    detail: document.getElementById('c_detail').value.trim(),
    symptoms: Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(c => c.value),
    order_type: orderType,
    payment_method: document.querySelector('input[name="payment_method"]:checked').value,
    fee_amount: feeInfo.amt,
    cancel_rule: document.getElementById('cancel_rule').value,
    req_sameday: !!document.getElementById('req_sameday').checked,
    contract_date: document.getElementById('c_contract_date').value,
    completion_date: document.getElementById('c_completion_date').value,
    consent_text: document.getElementById('consent_input').value.trim(),
    signature: document.getElementById('c_signature').value.trim(),
    is_additional: isAdditionalWork,
    submission_number: submissionCount + 1
  };

  // GASé€ä¿¡ï¼ˆURLãŒæœªè¨­å®šã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã›ãšå®Œäº†ç”»é¢ã«é€²ã‚€ï¼‰
  if (GAS_API_URL && !GAS_API_URL.includes('AKfycbw...') && GAS_API_URL.length >= 25) {
    try {
      await fetch(GAS_API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.log('é€ä¿¡å‡¦ç†ï¼šç’°å¢ƒã«ã‚ˆã‚Šå¿œç­”ãŒå–å¾—ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™', e);
    }
  } else {
    console.log('ã€ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€‘GAS_API_URLæœªè¨­å®šã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«é€ä¿¡ã®ã¿ï¼š', payload);
  }

  btn.disabled = false;
  btn.textContent = 'ä¸Šè¨˜ã«åŒæ„ã—ã¦é€ä¿¡';
  currentStep = COMPLETE_STEP;
  updateUI();
}

/* ========== è¿½åŠ å·¥äº‹ãƒ¢ãƒ¼ãƒ‰ ========== */
function startAdditionalWork() {
  isAdditionalWork = true;
  submissionCount++;

  const badge = document.getElementById('additionalBadge');
  const caseId = document.getElementById('c_case_prefix').value + '-' + document.getElementById('c_case_num').value.trim();
  const customerName = document.getElementById('c_name').value.trim();
  document.getElementById('badgeCaseId').textContent = caseId;
  document.getElementById('badgeCustomerName').textContent = customerName + ' æ§˜';
  badge.style.display = 'block';

  // ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.repair-item-row').forEach(row => {
    row.querySelector('.count-num').textContent = '0';
    row.classList.remove('active');
  });
  document.getElementById('extra_relocate').checked = false;
  document.getElementById('extra_hanging').checked = false;

  couponApplied = false;
  document.getElementById('c_coupon_code').value = '';
  document.getElementById('coupon_result').textContent = '';

  // ä½œæ¥­ç¨®åˆ¥ã‚’ã€Œä¿®ç†ã€ã«è‡ªå‹•é¸æŠ
  const repairRadio = document.querySelector('input[name="order_type"][value="ä¿®ç†"]');
  repairRadio.checked = true;
  repairRadio.dispatchEvent(new Event('change', { bubbles: true }));

  // ç½²åç­‰ã‚¯ãƒªã‚¢
  document.getElementById('consent_input').value = '';
  document.getElementById('c_signature').value = '';
  document.getElementById('req_sameday').checked = false;
  setFieldError('f_consent', false);
  setFieldError('f_sign', false);

  // ä½œæ¥­å®Œäº†æ—¥ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('c_completion_date').value = '';

  document.querySelector('.bottom-nav').style.display = 'flex';
  currentStep = 4;
  updateUI();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ========== å…¨ãƒªã‚»ãƒƒãƒˆ ========== */
function resetAll() {
  isAdditionalWork = false;
  submissionCount = 0;
  couponApplied = false;
  termsScrolled = false;

  document.getElementById('additionalBadge').style.display = 'none';

  document.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), textarea').forEach(el => {
    if (el.id !== 'cancel_rule') el.value = '';
  });
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

  // ç´„æ¬¾åŒæ„ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('agree_terms_check').disabled = true;
  document.getElementById('termsAgreeLabel').classList.add('terms-agree-disabled');
  document.getElementById('termsScrollHint').style.display = 'block';

  const diagRadio = document.querySelector('input[name="order_type"][value="åŸå› ç©¶æ˜ä½œæ¥­"]');
  diagRadio.checked = true;
  diagRadio.dispatchEvent(new Event('change', { bubbles: true }));
  const cashRadio = document.querySelector('input[name="payment_method"][value="ç¾é‡‘"]');
  cashRadio.checked = true;
  cashRadio.dispatchEvent(new Event('change', { bubbles: true }));

  document.querySelectorAll('.repair-item-row').forEach(row => {
    row.querySelector('.count-num').textContent = '0';
    row.classList.remove('active');
  });
  document.querySelectorAll('.equip-row').forEach(row => {
    row.querySelector('.count-num').textContent = '0';
    row.classList.remove('active');
  });

  document.getElementById('c_coupon_code').value = '';
  document.getElementById('coupon_result').textContent = '';
  document.querySelectorAll('.field').forEach(f => f.classList.remove('error'));

  // å¥‘ç´„æ—¥ã‚’ä»Šæ—¥ã«å†è¨­å®š
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('c_contract_date').value = today;

  document.querySelector('.bottom-nav').style.display = 'flex';
  currentStep = 1;
  updateUI();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>
